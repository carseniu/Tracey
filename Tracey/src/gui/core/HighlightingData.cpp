#include "HighlightingData.h"

#include "src/Tracey.h"
#include "src/gui/core/Configuration.h"
#include "src/gui/core/HighlightingGroup.h"
#include "src/gui/core/HighlightingRule.h"

#include <QDebug>

using namespace Tracey;


//===================================================================================================================================================================================================//
// PUBLIC
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
HighlightingData::HighlightingData(QObject* parent) :
  QObject(parent),
  DEFAULT_COLORS({ ColorPair("#ff0000", "#ffff00"), ColorPair("#0000ff", "#aaffff"), ColorPair("#060050", "#ffff7f"), ColorPair("#ffffff", "#ff0000"), ColorPair("#ffffff", "#0000ff"),
                   ColorPair("#ffff00", "#666600"), ColorPair("#000000", "#ff6b21"), ColorPair("#aa00ff", "#40ff33"), ColorPair("#ff0000", "#ffff00"), ColorPair("#ffffff", "#aa0000"),
                   ColorPair("#aa0000", "#ffff7f"), ColorPair("#ffff00", "#aa6877"), ColorPair("#000000", "#6bff35"), ColorPair("#000000", "#aaaa00"), ColorPair("#000000", "#ff0000"),
                   ColorPair("#000000", "#ff00ff"), ColorPair("#55ffff", "#00007f"), ColorPair("#ffffff", "#0a6800"), ColorPair("#ffffff", "#000000"), ColorPair("#000000", "#ffff7f") })
{
  groups << Config().getHighlightingGroups();
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
HighlightingData::~HighlightingData()
{
  qDeleteAll(groups);
  groups.clear();
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
QString HighlightingData::addGroup(const QString& name)
{
  QString id = createId();

  HighlightingGroup* group = new HighlightingGroup(id, name);

  groups << group;

  Config().addHighlightingGroup(group);

  emit groupsChanged(groups);

  return id;
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void HighlightingData::deleteGroup(const QString& id)
{
  HighlightingGroup* group = getGroup(id);

  groups.removeAll(group);
  delete group;

  Config().deleteHighlightingGroup(id);

  emit groupsChanged(groups);
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void HighlightingData::deleteRule(const QString& id, const QString& groupId)
{
  HighlightingGroup* group = getGroup(groupId);

  group->deleteRule(id);

  Config().deleteHighlightingRule(id);

  emit highlightingChanged(groupId);
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
QString HighlightingData::addRule(const QString& name, const QString& groupId)
{
  QString id = createId();
  int maxSort = Config().getHighlightingRulesMaxSort(groupId);

  HighlightingGroup* group = getGroup(groupId);
  ColorPair colors = DEFAULT_COLORS.at(group->getRules().size() % DEFAULT_COLORS.size());

  HighlightingRule* rule = new HighlightingRule(id, name, colors.first, colors.second, false, false, true, maxSort + 1);

  group->addRule(rule);

  Config().addHighlightingRule(rule, group->getId());

  emit highlightingChanged(groupId);

  return id;
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
HighlightingGroup* HighlightingData::getGroup(const QString& id)
{
  for (HighlightingGroup* group : groups)
  {
    if (group->getId() == id)
    {
      return group;
    }
  }

  return nullptr;
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
QVector<HighlightingGroup*> HighlightingData::getGroups() const
{
  return groups;
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
HighlightingRule* HighlightingData::getRule(const QString& ruleId, const QString& groupId)
{
  HighlightingGroup* group = getGroup(groupId);

  return group->getRule(ruleId);
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
QVector<HighlightingRule*> HighlightingData::getRules(const QString& groupId)
{
  HighlightingGroup* group = getGroup(groupId);

  return group->getRules();
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void HighlightingData::moveRule(int oldPosition, int newPosition, const QString& groupId)
{
  HighlightingGroup* group = getGroup(groupId);

  group->moveRule(oldPosition, newPosition);

  emit highlightingChanged(groupId);
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void HighlightingData::updateRule(HighlightingRule* rule, const QString& groupId)
{
  HighlightingGroup* group = getGroup(groupId);

  group->updateRule(rule);

  Config().updateHighlightingRule(rule);

  emit highlightingChanged(groupId);
}