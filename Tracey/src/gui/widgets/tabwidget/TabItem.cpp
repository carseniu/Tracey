#include "src/gui/widgets/tabwidget/TabItem.h"

#include "src/gui/widgets/tabwidget/TabBar.h"

#include <QMouseEvent>


//===================================================================================================================================================================================================//
// PUBLIC
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
TabItem::TabItem(const QString& text, TabBar* parent) :
  QPushButton(parent)
{
  styleSheet = "QPushButton {background-color:#d8dddf; border:1px solid #727a7e}";
  styleSheetSelected = "QPushButton {background-color:#f8f8f8; border:1px solid #727a7e; border-bottom:transparent; padding-bottom:1px}";
  styleSheetMoving = "QPushButton {margin-left:20px; margin-right:20px; background-color:#f8f8f8; border:1px solid #727a7e; border-bottom:transparent; padding-bottom:1px}";

  setText(text);
  setLook();
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
QString TabItem::getText() const
{
  return text;
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
bool TabItem::isFixed() const
{
  return fixed;
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
bool TabItem::isSelected() const
{
  return selected;
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TabItem::setFixed(bool fixed)
{
  this->fixed = fixed;
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TabItem::setText(const QString& text)
{
  this->text = text;

  QPushButton::setText(fontMetrics().elidedText(text, Qt::ElideRight, width() - nameResizeOffset));

  setToolTip(text);
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TabItem::setSelected(bool selected)
{
  this->selected = selected;

  setLook();

  if (selected)
  {
    emit itemSelected();
  }
}


//===================================================================================================================================================================================================//
// PROTECTED
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TabItem::mouseMoveEvent(QMouseEvent* event)
{
  if (!fixed && pressed)
  {
    // The item is "wider" when moving so increase the resize offset
    nameResizeOffset = 70;

    setStyleSheet(styleSheetMoving);

    emit itemMoved(event->pos(), mapToParent(event->pos()));
  }
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TabItem::mousePressEvent(QMouseEvent* event)
{
  setLook();

  emit itemPressed(event->pos(), mapToParent(event->pos()));

  if (event->button() == Qt::LeftButton)
  {
    pressed = true;
  }
  else if (event->button() == Qt::RightButton)
  {
    emit contextMenuRequested(mapToGlobal(event->pos()));
  }
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TabItem::mouseReleaseEvent(QMouseEvent* event)
{
  if (event->button() == Qt::LeftButton)
  {
    nameResizeOffset = 30;

    setLook();

    emit itemReleased(mapToParent(event->pos()));

    pressed = false;
  }
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TabItem::resizeEvent(QResizeEvent* event)
{
  setText(text);
}


//===================================================================================================================================================================================================//
// PRIVATE
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TabItem::setLook()
{
  if (selected)
  {
    setStyleSheet(styleSheetSelected);
  }
  else
  {
    setStyleSheet(styleSheet);
  }
}