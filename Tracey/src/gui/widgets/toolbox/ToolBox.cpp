#include "src/gui/widgets/toolbox/ToolBox.h"

#include "src/gui/widgets/toolbox/ToolBoxItem.h"

#include <QDebug>
#include <QResizeEvent>
#include <QScrollArea>
#include <QScrollBar>
#include <QVBoxLayout>


//===================================================================================================================================================================================================//
// PUBLIC
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
ToolBox::ToolBox(QWidget* parent) :
  QFrame(parent),
  contentWidget(nullptr),
  itemLayout(nullptr),
  scrollBarVisible(false),
  spacing(4)
{
  contentWidget = new QFrame(this);
  contentWidget->setObjectName("ToolBox");

  scrollArea = new QScrollArea(this);
  scrollArea->setWidget(contentWidget);
  scrollArea->setHorizontalScrollBarPolicy(Qt::ScrollBarAlwaysOff);
  scrollArea->setWidgetResizable(true);
  scrollArea->setVerticalScrollBar(new QScrollBar(Qt::Vertical, scrollArea));
  scrollArea->verticalScrollBar()->installEventFilter(this);

  QVBoxLayout* mainLayout = new QVBoxLayout(this);
  mainLayout->setMargin(0);
  mainLayout->setSpacing(0);
  mainLayout->addWidget(scrollArea);
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void ToolBox::addItem(QWidget* widget, const QString& text)
{
  ToolBoxItem* item = new ToolBoxItem(widget, text, this);
  connect(item, &ToolBoxItem::sizeChanged, this, &ToolBox::updateLayout);

  items.append(item);

  updateLayout();
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
bool ToolBox::eventFilter(QObject* watched, QEvent* event)
{
  if (event->type() == QEvent::Show) {
    scrollBarVisible = true;
    setContentWidth();
    return true;
  }
  else if (event->type() == QEvent::Hide) {
    scrollBarVisible = false;
    setContentWidth();
    return true;
  }

  return QWidget::eventFilter(watched, event);
}


//===================================================================================================================================================================================================//
// PROTECTED
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void ToolBox::resizeEvent(QResizeEvent* event)
{
  setContentWidth();
}


//===================================================================================================================================================================================================//
// PRIVATE
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void ToolBox::setContentWidth()
{
  if (scrollBarVisible)
  {
    contentWidget->setFixedWidth(width() - scrollArea->verticalScrollBar()->width() - 6);
    contentWidget->setStyleSheet("QFrame#ToolBox{margin-right:1px}");
  }
  else
  {
    contentWidget->setFixedWidth(width() - 6);
    contentWidget->setStyleSheet("QFrame#ToolBox{margin-right:0}");
  }
}


//===================================================================================================================================================================================================//
// PRIVATE SLOTS
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void ToolBox::updateLayout()
{
  delete itemLayout;
  itemLayout = new QVBoxLayout(contentWidget);
  itemLayout->setMargin(0);
  itemLayout->setSpacing(spacing);

  int height = 0;
  for (ToolBoxItem* item : items)
  {
    itemLayout->addWidget(item);

    height += item->height();
  }

  height += spacing * (items.size() - 1);

  contentWidget->setFixedHeight(height);
}