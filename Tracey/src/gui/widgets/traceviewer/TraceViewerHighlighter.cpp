#include "src/gui/widgets/traceviewer/TraceViewerHighlighter.h"

#include "src/gui/core/HighlightingRule.h"

#include <QTextDocument>


//===================================================================================================================================================================================================//
// PUBLIC
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
TraceViewerHighlighter::TraceViewerHighlighter(QTextDocument* document) :
  QSyntaxHighlighter(document)
{
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TraceViewerHighlighter::setRules(const QVector<HighlightingRule*>& rules)
{
  this->rules = rules;
}


//===================================================================================================================================================================================================//
// PROTECTED
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TraceViewerHighlighter::highlightBlock(const QString& text)
{
  for (HighlightingRule* rule : rules)
  {
    highlightRule(text, rule);
  }
}


//===================================================================================================================================================================================================//
// PRIVATE
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TraceViewerHighlighter::highlightRule(const QString& text, HighlightingRule* rule)
{
  if (rule->isEnabled())
  {
    QRegularExpression regExp = rule->getRegularExpression();
    QRegularExpressionMatchIterator matchIterator = regExp.globalMatch(text);

    while (matchIterator.hasNext())
    {
      QRegularExpressionMatch match = matchIterator.next();

      setFormat(match.capturedStart(), match.capturedLength(), rule->getFormat());
    }
  }
}