#include "src/logic/core/TraceWorker.h"

#include <QDateTime>
#include <QDebug>
#include <QThread>


//===================================================================================================================================================================================================//
// PUBLIC
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
TraceWorker::TraceWorker(bool preload) :
  preload(preload),
  running(true),
  reset(false),
  progressUpdateInterval(100),
  updateInterval(100),
  progressUpdateTime(QDateTime::currentMSecsSinceEpoch())
{
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TraceWorker::doStop()
{
  running = false;
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
bool TraceWorker::isReset()
{
  return reset;
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
bool TraceWorker::isRunning()
{
  return running;
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TraceWorker::setReset(bool reset)
{
  this->reset = reset;
}


//===================================================================================================================================================================================================//
// PROTECTED
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TraceWorker::doUpdateProgress(int step)
{
  qint64 currentTime = QDateTime::currentMSecsSinceEpoch();
  if (currentTime - progressUpdateTime > progressUpdateInterval)
  {
    emit stepReady(step);

    progressUpdateTime = currentTime;
  }
}


//===================================================================================================================================================================================================//
// PUBLIC SLOTS
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void TraceWorker::process()
{
  if (preload)
  {
    doWork(TraceWorker::Content);
  }

  emit updatesProcessStarted();

  while (running)
  {
    doWork(TraceWorker::Updates);

    QThread::msleep(updateInterval);
  }

  emit updatesProcessFinished();

  emit finished();
}