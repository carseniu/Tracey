#include "src/logic/search/SearchWorkerCount.h"

#include "src/logic/core/TraceData.h"

#include <QDebug>


//===================================================================================================================================================================================================//
// PUBLIC
//===================================================================================================================================================================================================//

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
SearchWorkerCount::SearchWorkerCount(TraceData* traceData, const QRegularExpression& regexp) :
  SearchWorker(),
  traceData(traceData),
  regexp(regexp),
  batchSize(10000)
{
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
SearchWorkerCount::~SearchWorkerCount()
{
}

//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------//
void SearchWorkerCount::process()
{
  int dataSize = traceData->getSize();
  int lineCount = 0;
  int count = 0;

  for (int i = 0; i < dataSize; i = i + batchSize)
  {
    QStringList lines = traceData->getLines(i, batchSize);

    for (int j = 0; j < lines.size(); ++j)
    {
      if (isCanceled())
      {
        emit finished();
        return;
      }

      lineCount++;

      QRegularExpressionMatchIterator iterator = regexp.globalMatch(lines.at(j));

      QList<QRegularExpressionMatch> matches;

      while (iterator.hasNext()) {
        QRegularExpressionMatch match = iterator.next();

        if (match.hasMatch()) {
          count++;
        }
      }
 
      doUpdateProgress((double)lineCount / dataSize * 100, count);
    }
  }

  if (count == 0)
  {
    emit matchNotFound();
  }

  emit updateReady(100, count);

  emit finished();
}